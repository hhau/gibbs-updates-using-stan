---
title: "Using Stan for Gibbs Updates"
author: "Andrew Manderson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
fontfamily: tgpagella
fontsize: 10pt
papersize: a4
geometry: margin=2.25cm
bibliography: ../0bibliography/year-1-bib.bib
csl: aam71-test.csl
output: 
  pdf_document:
    includes:
      in_header:
        tex-input/pre.tex
    fig_caption: true
    number_sections: true
    keep_tex: true
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, out.width = "80%", fig.align = "center", auto_pdf = TRUE)
```

# Introduction

Can we use Stan for Gibbs style updates.

# Example

## Model

Consider the following random intercept regression
\input{tex-input/model/0010-reg-model.tex}
The priors are 
\input{tex-input/model/0020-reg-priors.tex}
and we simulate data from this model using $J = 3$, with $n_{j} = 50$ for each $j$.

## Gibbs updates

The joint posterior expression is
\input{tex-input/gibbs-updates/0010-joint-post.tex}
We can use Gibbs updates to alternate sampling between $\pd(\boldsymbol{\alpha} \mid Y, \phi)$ and $\pd(\phi \mid Y, \boldsymbol{\alpha})$ to generate samples from the desired posterior distribution. 

We can use Stan to alternate between sampling these conditional distributions.
The Stan model that samples $\pd(\phi \mid Y, \boldsymbol{\alpha})$ is contained in Appendix&nbsp;\ref{stan-model-for-phi-updates}, and the model for $\pd(\boldsymbol{\alpha} \mid Y, \phi)$ in Appendix&nbsp;\ref{stan-model-for-alpha-updates}.

The difference between these two models is the exchange of $\boldsymbol{\alpha}$ and $\phi$ between the `data` block and the `parameters` block.
We could remove the line in the `model` block that pertains to the prior on $\boldsymbol{\alpha}$ or $\phi$ when each is an element of the `data` block, but such removal would only be for speed.
It is still methodologically valid to keep the static prior present, as it they are a constant and do not affect the conditional of interest.

## Output

We compare the posterior samples generated using the Gibbs updates against those generated by directly targeting the joint posterior.
Figure&nbsp;\ref{fig:phi_qq} displays the quantile-quantile plot of the posterior samples of $\phi$ under both update schemas, and we see no discrepancy between the samples.
Similarly, the traceplots of the $\alpha_{j}$ parameters depicted in Figure&nbsp;\ref{fig:alpha_trace} show well behaved Markov chains for both update types.

```{r phi_qq, fig.cap = "Q-Q plot of the samples of $\\phi$ obtained from directly targeting the joint posterior, and using Gibbs updates for the conditionals."}
knitr::include_graphics("plots/phi-qq-plot.pdf")
```

```{r alpha_trace, fig.cap = "Traceplot of the samples of $\\alpha$ using both types of updates"}
knitr::include_graphics("plots/alpha-trace.pdf")
```

# From here

- This is quite slow at the moment, because I let Stan sample 500 times for each Gibbs update. 
    - The upside of this is that we always get a good sample from each conditional.
    - Can I fix it at the optimum stepsize / number of steps afters a certain number?
- How do I automatically generate these models given the joint Stan model.

# Conclusion

Concise summary

<!-- -------------------- END OF MAIN BODY OF DOCUMENT -------------------- -->
\newpage

<!-- The {-} tag here suppresses the section numbering. -->
# Bibliography {-}

<!-- This makes pandoc-citeproc put the references before the end of document. -->
<div id="refs"></div>

\newpage

<!-- Now switch to alphabetical numbering for the appendix, and reset the counter. -->
\renewcommand{\thesection}{\Alph{section}}
\setcounter{section}{0}

# Stan model for $\phi$ updates

```{r}
cat(readLines("scripts/stan-files/phi-update.stan"), sep = "\n")
```

# Stan model for $\alpha$ updates 

```{r}
cat(readLines("scripts/stan-files/alpha-update.stan"), sep = "\n")
```
